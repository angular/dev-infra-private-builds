"use strict";
/**
 * @license
 * Copyright Google LLC All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.BranchOffNextBranchBaseAction = void 0;
const semver = require("semver");
const console_1 = require("../../../utils/console");
const semver_1 = require("../../../utils/semver");
const next_prerelease_version_1 = require("../../versioning/next-prerelease-version");
const actions_1 = require("../actions");
const commit_message_1 = require("../commit-message");
const constants_1 = require("../constants");
/**
 * Base action that can be used to move the next release-train into the feature-freeze or
 * release-candidate phase. This means that a new version branch is created from the next
 * branch, and a new pre-release (either RC or another `next`) is cut indicating the new phase.
 */
class BranchOffNextBranchBaseAction extends actions_1.ReleaseAction {
    async getDescription() {
        const { branchName } = this.active.next;
        const newVersion = await this._computeNewVersion();
        return `Move the "${branchName}" branch into ${this.newPhaseName} phase (v${newVersion}).`;
    }
    async perform() {
        const compareVersionForReleaseNotes = await next_prerelease_version_1.getReleaseNotesCompareVersionForNext(this.active, this.config);
        const newVersion = await this._computeNewVersion();
        const newBranch = `${newVersion.major}.${newVersion.minor}.x`;
        // Branch-off the next branch into a new version branch.
        await this._createNewVersionBranchFromNext(newBranch);
        // Stage the new version for the newly created branch, and push changes to a
        // fork in order to create a staging pull request. Note that we re-use the newly
        // created branch instead of re-fetching from the upstream.
        const { pullRequest, releaseNotes } = await this.stageVersionForBranchAndCreatePullRequest(newVersion, compareVersionForReleaseNotes, newBranch);
        // Wait for the staging PR to be merged. Then build and publish the feature-freeze next
        // pre-release. Finally, cherry-pick the release notes into the next branch in combination
        // with bumping the version to the next minor too.
        await this.waitForPullRequestToBeMerged(pullRequest);
        await this.buildAndPublish(releaseNotes, newBranch, 'next');
        await this._createNextBranchUpdatePullRequest(releaseNotes, newVersion);
    }
    /** Computes the new version for the release-train being branched-off. */
    async _computeNewVersion() {
        if (this.newPhaseName === 'feature-freeze') {
            return next_prerelease_version_1.computeNewPrereleaseVersionForNext(this.active, this.config);
        }
        else {
            return semver_1.semverInc(this.active.next.version, 'prerelease', 'rc');
        }
    }
    /** Creates a new version branch from the next branch. */
    async _createNewVersionBranchFromNext(newBranch) {
        const { branchName: nextBranch } = this.active.next;
        await this.verifyPassingGithubStatus(nextBranch);
        await this.checkoutUpstreamBranch(nextBranch);
        await this.createLocalBranchFromHead(newBranch);
        await this.pushHeadToRemoteBranch(newBranch);
        console_1.info(console_1.green(`  ✓   Version branch "${newBranch}" created.`));
    }
    /**
     * Creates a pull request for the next branch that bumps the version to the next
     * minor, and cherry-picks the changelog for the newly branched-off release-candidate
     * or feature-freeze version.
     */
    async _createNextBranchUpdatePullRequest(releaseNotes, newVersion) {
        const { branchName: nextBranch, version } = this.active.next;
        // We increase the version for the next branch to the next minor. The team can decide
        // later if they want next to be a major through the `Configure Next as Major` release action.
        const newNextVersion = semver.parse(`${version.major}.${version.minor + 1}.0-next.0`);
        const bumpCommitMessage = commit_message_1.getCommitMessageForExceptionalNextVersionBump(newNextVersion);
        await this.checkoutUpstreamBranch(nextBranch);
        await this.updateProjectVersion(newNextVersion);
        // Create an individual commit for the next version bump. The changelog should go into
        // a separate commit that makes it clear where the changelog is cherry-picked from.
        await this.createCommit(bumpCommitMessage, [constants_1.packageJsonPath]);
        await this.prependReleaseNotesToChangelog(releaseNotes);
        const commitMessage = commit_message_1.getReleaseNoteCherryPickCommitMessage(releaseNotes.version);
        await this.createCommit(commitMessage, [constants_1.changelogPath]);
        let nextPullRequestMessage = `The previous "next" release-train has moved into the ` +
            `${this.newPhaseName} phase. This PR updates the next branch to the subsequent ` +
            `release-train.\n\nAlso this PR cherry-picks the changelog for ` +
            `v${newVersion} into the ${nextBranch} branch so that the changelog is up to date.`;
        const nextUpdatePullRequest = await this.pushChangesToForkAndCreatePullRequest(nextBranch, `next-release-train-${newNextVersion}`, `Update next branch to reflect new release-train "v${newNextVersion}".`, nextPullRequestMessage);
        console_1.info(console_1.green(`  ✓   Pull request for updating the "${nextBranch}" branch has been created.`));
        console_1.info(console_1.yellow(`      Please ask team members to review: ${nextUpdatePullRequest.url}.`));
    }
}
exports.BranchOffNextBranchBaseAction = BranchOffNextBranchBaseAction;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnJhbmNoLW9mZi1uZXh0LWJyYW5jaC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL25nLWRldi9yZWxlYXNlL3B1Ymxpc2gvYWN0aW9ucy9icmFuY2gtb2ZmLW5leHQtYnJhbmNoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7O0dBTUc7OztBQUVILGlDQUFpQztBQUVqQyxvREFBMkQ7QUFDM0Qsa0RBQWdEO0FBRWhELHNGQUdrRDtBQUNsRCx3Q0FBeUM7QUFDekMsc0RBRzJCO0FBQzNCLDRDQUE0RDtBQUU1RDs7OztHQUlHO0FBQ0gsTUFBc0IsNkJBQThCLFNBQVEsdUJBQWE7SUFVOUQsS0FBSyxDQUFDLGNBQWM7UUFDM0IsTUFBTSxFQUFDLFVBQVUsRUFBQyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDO1FBQ3RDLE1BQU0sVUFBVSxHQUFHLE1BQU0sSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7UUFDbkQsT0FBTyxhQUFhLFVBQVUsaUJBQWlCLElBQUksQ0FBQyxZQUFZLFlBQVksVUFBVSxJQUFJLENBQUM7SUFDN0YsQ0FBQztJQUVRLEtBQUssQ0FBQyxPQUFPO1FBQ3BCLE1BQU0sNkJBQTZCLEdBQUcsTUFBTSw4REFBb0MsQ0FDOUUsSUFBSSxDQUFDLE1BQU0sRUFDWCxJQUFJLENBQUMsTUFBTSxDQUNaLENBQUM7UUFDRixNQUFNLFVBQVUsR0FBRyxNQUFNLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1FBQ25ELE1BQU0sU0FBUyxHQUFHLEdBQUcsVUFBVSxDQUFDLEtBQUssSUFBSSxVQUFVLENBQUMsS0FBSyxJQUFJLENBQUM7UUFFOUQsd0RBQXdEO1FBQ3hELE1BQU0sSUFBSSxDQUFDLCtCQUErQixDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRXRELDRFQUE0RTtRQUM1RSxnRkFBZ0Y7UUFDaEYsMkRBQTJEO1FBQzNELE1BQU0sRUFBQyxXQUFXLEVBQUUsWUFBWSxF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QixjQUFjLEVBQUUsRUFDdEMscURBQXFELGNBQWMsSUFBSSxFQUN2RSxzQkFBc0IsQ0FDdkIsQ0FBQztRQUVGLGNBQUksQ0FBQyxlQUFLLENBQUMsd0NBQXdDLFVBQVUsNEJBQTRCLENBQUMsQ0FBQyxDQUFDO1FBQzVGLGNBQUksQ0FBQyxnQkFBTSxDQUFDLDRDQUE0QyxxQkFBcUIsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDekYsQ0FBQztDQUNGO0FBM0dELHNFQTJHQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBHb29nbGUgTExDIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuXG5pbXBvcnQgKiBhcyBzZW12ZXIgZnJvbSAnc2VtdmVyJztcblxuaW1wb3J0IHtncmVlbiwgaW5mbywgeWVsbG93fSBmcm9tICcuLi8uLi8uLi91dGlscy9jb25zb2xlJztcbmltcG9ydCB7c2VtdmVySW5jfSBmcm9tICcuLi8uLi8uLi91dGlscy9zZW12ZXInO1xuaW1wb3J0IHtSZWxlYXNlTm90ZXN9IGZyb20gJy4uLy4uL25vdGVzL3JlbGVhc2Utbm90ZXMnO1xuaW1wb3J0IHtcbiAgY29tcHV0ZU5ld1ByZXJlbGVhc2VWZXJzaW9uRm9yTmV4dCxcbiAgZ2V0UmVsZWFzZU5vdGVzQ29tcGFyZVZlcnNpb25Gb3JOZXh0LFxufSBmcm9tICcuLi8uLi92ZXJzaW9uaW5nL25leHQtcHJlcmVsZWFzZS12ZXJzaW9uJztcbmltcG9ydCB7UmVsZWFzZUFjdGlvbn0gZnJvbSAnLi4vYWN0aW9ucyc7XG5pbXBvcnQge1xuICBnZXRDb21taXRNZXNzYWdlRm9yRXhjZXB0aW9uYWxOZXh0VmVyc2lvbkJ1bXAsXG4gIGdldFJlbGVhc2VOb3RlQ2hlcnJ5UGlja0NvbW1pdE1lc3NhZ2UsXG59IGZyb20gJy4uL2NvbW1pdC1tZXNzYWdlJztcbmltcG9ydCB7Y2hhbmdlbG9nUGF0aCwgcGFja2FnZUpzb25QYXRofSBmcm9tICcuLi9jb25zdGFudHMnO1xuXG4vKipcbiAqIEJhc2UgYWN0aW9uIHRoYXQgY2FuIGJlIHVzZWQgdG8gbW92ZSB0aGUgbmV4dCByZWxlYXNlLXRyYWluIGludG8gdGhlIGZlYXR1cmUtZnJlZXplIG9yXG4gKiByZWxlYXNlLWNhbmRpZGF0ZSBwaGFzZS4gVGhpcyBtZWFucyB0aGF0IGEgbmV3IHZlcnNpb24gYnJhbmNoIGlzIGNyZWF0ZWQgZnJvbSB0aGUgbmV4dFxuICogYnJhbmNoLCBhbmQgYSBuZXcgcHJlLXJlbGVhc2UgKGVpdGhlciBSQyBvciBhbm90aGVyIGBuZXh0YCkgaXMgY3V0IGluZGljYXRpbmcgdGhlIG5ldyBwaGFzZS5cbiAqL1xuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEJyYW5jaE9mZk5leHRCcmFuY2hCYXNlQWN0aW9uIGV4dGVuZHMgUmVsZWFzZUFjdGlvbiB7XG4gIC8qKlxuICAgKiBQaGFzZSB3aGljaCB0aGUgcmVsZWFzZS10cmFpbiBjdXJyZW50bHkgaW4gdGhlIGBuZXh0YCBwaGFzZSB3aWxsIG1vdmUgaW50by5cbiAgICpcbiAgICogTm90ZSB0aGF0IHdlIG9ubHkgYWxsb3cgZm9yIGEgbmV4dCB2ZXJzaW9uIHRvIGJyYW5jaCBpbnRvIGZlYXR1cmUtZnJlZXplIG9yXG4gICAqIGRpcmVjdGx5IGludG8gdGhlIHJlbGVhc2UtY2FuZGlkYXRlIHBoYXNlLiBBIHN0YWJsZSB2ZXJzaW9uIGNhbm5vdCBiZSByZWxlYXNlZFxuICAgKiB3aXRob3V0IHJlbGVhc2UtY2FuZGlkYXRlLlxuICAgKi9cbiAgYWJzdHJhY3QgbmV3UGhhc2VOYW1lOiAnZmVhdHVyZS1mcmVlemUnIHwgJ3JlbGVhc2UtY2FuZGlkYXRlJztcblxuICBvdmVycmlkZSBhc3luYyBnZXREZXNjcmlwdGlvbigpIHtcbiAgICBjb25zdCB7YnJhbmNoTmFtZX0gPSB0aGlzLmFjdGl2ZS5uZXh0O1xuICAgIGNvbnN0IG5ld1ZlcnNpb24gPSBhd2FpdCB0aGlzLl9jb21wdXRlTmV3VmVyc2lvbigpO1xuICAgIHJldHVybiBgTW92ZSB0aGUgXCIke2JyYW5jaE5hbWV9XCIgYnJhbmNoIGludG8gJHt0aGlzLm5ld1BoYXNlTmFtZX0gcGhhc2UgKHYke25ld1ZlcnNpb259KS5gO1xuICB9XG5cbiAgb3ZlcnJpZGUgYXN5bmMgcGVyZm9ybSgpIHtcbiAgICBjb25zdCBjb21wYXJlVmVyc2lvbkZvclJlbGVhc2VOb3RlcyA9IGF3YWl0IGdldFJlbGVhc2VOb3Rlc0NvbXBhcmVWZXJzaW9uRm9yTmV4dChcbiAgICAgIHRoaXMuYWN0aXZlLFxuICAgICAgdGhpcy5jb25maWcsXG4gICAgKTtcbiAgICBjb25zdCBuZXdWZXJzaW9uID0gYXdhaXQgdGhpcy5fY29tcHV0ZU5ld1ZlcnNpb24oKTtcbiAgICBjb25zdCBuZXdCcmFuY2ggPSBgJHtuZXdWZXJzaW9uLm1ham9yfS4ke25ld1ZlcnNpb24ubWlub3J9LnhgO1xuXG4gICAgLy8gQnJhbmNoLW9mZiB0aGUgbmV4dCBicmFuY2ggaW50byBhIG5ldyB2ZXJzaW9uIGJyYW5jaC5cbiAgICBhd2FpdCB0aGlzLl9jcmVhdGVOZXdWZXJzaW9uQnJhbmNoRnJvbU5leHQobmV3QnJhbmNoKTtcblxuICAgIC8vIFN0YWdlIHRoZSBuZXcgdmVyc2lvbiBmb3IgdGhlIG5ld2x5IGNyZWF0ZWQgYnJhbmNoLCBhbmQgcHVzaCBjaGFuZ2VzIHRvIGFcbiAgICAvLyBmb3JrIGluIG9yZGVyIHRvIGNyZWF0ZSBhIHN0YWdpbmcgcHVsbCByZXF1ZXN0LiBOb3RlIHRoYXQgd2UgcmUtdXNlIHRoZSBuZXdseVxuICAgIC8vIGNyZWF0ZWQgYnJhbmNoIGluc3RlYWQgb2YgcmUtZmV0Y2hpbmcgZnJvbSB0aGUgdXBzdHJlYW0uXG4gICAgY29uc3Qge3B1bGxSZXF1ZXN0LCByZWxlYXNlTm90ZXN9ID0gYXdhaXQgdGhpcy5zdGFnZVZlcnNpb25Gb3JCcmFuY2hBbmRDcmVhdGVQdWxsUmVxdWVzdChcbiAgICAgIG5ld1ZlcnNpb24sXG4gICAgICBjb21wYXJlVmVyc2lvbkZvclJlbGVhc2VOb3RlcyxcbiAgICAgIG5ld0JyYW5jaCxcbiAgICApO1xuXG4gICAgLy8gV2FpdCBmb3IgdGhlIHN0YWdpbmcgUFIgdG8gYmUgbWVyZ2VkLiBUaGVuIGJ1aWxkIGFuZCBwdWJsaXNoIHRoZSBmZWF0dXJlLWZyZWV6ZSBuZXh0XG4gICAgLy8gcHJlLXJlbGVhc2UuIEZpbmFsbHksIGNoZXJyeS1waWNrIHRoZSByZWxlYXNlIG5vdGVzIGludG8gdGhlIG5leHQgYnJhbmNoIGluIGNvbWJpbmF0aW9uXG4gICAgLy8gd2l0aCBidW1waW5nIHRoZSB2ZXJzaW9uIHRvIHRoZSBuZXh0IG1pbm9yIHRvby5cbiAgICBhd2FpdCB0aGlzLndhaXRGb3JQdWxsUmVxdWVzdFRvQmVNZXJnZWQocHVsbFJlcXVlc3QpO1xuICAgIGF3YWl0IHRoaXMuYnVpbGRBbmRQdWJsaXNoKHJlbGVhc2VOb3RlcywgbmV3QnJhbmNoLCAnbmV4dCcpO1xuICAgIGF3YWl0IHRoaXMuX2NyZWF0ZU5leHRCcmFuY2hVcGRhdGVQdWxsUmVxdWVzdChyZWxlYXNlTm90ZXMsIG5ld1ZlcnNpb24pO1xuICB9XG5cbiAgLyoqIENvbXB1dGVzIHRoZSBuZXcgdmVyc2lvbiBmb3IgdGhlIHJlbGVhc2UtdHJhaW4gYmVpbmcgYnJhbmNoZWQtb2ZmLiAqL1xuICBwcml2YXRlIGFzeW5jIF9jb21wdXRlTmV3VmVyc2lvbigpIHtcbiAgICBpZiAodGhpcy5uZXdQaGFzZU5hbWUgPT09ICdmZWF0dXJlLWZyZWV6ZScpIHtcbiAgICAgIHJldHVybiBjb21wdXRlTmV3UHJlcmVsZWFzZVZlcnNpb25Gb3JOZXh0KHRoaXMuYWN0aXZlLCB0aGlzLmNvbmZpZyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBzZW12ZXJJbmModGhpcy5hY3RpdmUubmV4dC52ZXJzaW9uLCAncHJlcmVsZWFzZScsICdyYycpO1xuICAgIH1cbiAgfVxuXG4gIC8qKiBDcmVhdGVzIGEgbmV3IHZlcnNpb24gYnJhbmNoIGZyb20gdGhlIG5leHQgYnJhbmNoLiAqL1xuICBwcml2YXRlIGFzeW5jIF9jcmVhdGVOZXdWZXJzaW9uQnJhbmNoRnJvbU5leHQobmV3QnJhbmNoOiBzdHJpbmcpIHtcbiAgICBjb25zdCB7YnJhbmNoTmFtZTogbmV4dEJyYW5jaH0gPSB0aGlzLmFjdGl2ZS5uZXh0O1xuICAgIGF3YWl0IHRoaXMudmVyaWZ5UGFzc2luZ0dpdGh1YlN0YXR1cyhuZXh0QnJhbmNoKTtcbiAgICBhd2FpdCB0aGlzLmNoZWNrb3V0VXBzdHJlYW1CcmFuY2gobmV4dEJyYW5jaCk7XG4gICAgYXdhaXQgdGhpcy5jcmVhdGVMb2NhbEJyYW5jaEZyb21IZWFkKG5ld0JyYW5jaCk7XG4gICAgYXdhaXQgdGhpcy5wdXNoSGVhZFRvUmVtb3RlQnJhbmNoKG5ld0JyYW5jaCk7XG4gICAgaW5mbyhncmVlbihgICDinJMgICBWZXJzaW9uIGJyYW5jaCBcIiR7bmV3QnJhbmNofVwiIGNyZWF0ZWQuYCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYSBwdWxsIHJlcXVlc3QgZm9yIHRoZSBuZXh0IGJyYW5jaCB0aGF0IGJ1bXBzIHRoZSB2ZXJzaW9uIHRvIHRoZSBuZXh0XG4gICAqIG1pbm9yLCBhbmQgY2hlcnJ5LXBpY2tzIHRoZSBjaGFuZ2Vsb2cgZm9yIHRoZSBuZXdseSBicmFuY2hlZC1vZmYgcmVsZWFzZS1jYW5kaWRhdGVcbiAgICogb3IgZmVhdHVyZS1mcmVlemUgdmVyc2lvbi5cbiAgICovXG4gIHByaXZhdGUgYXN5bmMgX2NyZWF0ZU5leHRCcmFuY2hVcGRhdGVQdWxsUmVxdWVzdChcbiAgICByZWxlYXNlTm90ZXM6IFJlbGVhc2VOb3RlcyxcbiAgICBuZXdWZXJzaW9uOiBzZW12ZXIuU2VtVmVyLFxuICApIHtcbiAgICBjb25zdCB7YnJhbmNoTmFtZTogbmV4dEJyYW5jaCwgdmVyc2lvbn0gPSB0aGlzLmFjdGl2ZS5uZXh0O1xuICAgIC8vIFdlIGluY3JlYXNlIHRoZSB2ZXJzaW9uIGZvciB0aGUgbmV4dCBicmFuY2ggdG8gdGhlIG5leHQgbWlub3IuIFRoZSB0ZWFtIGNhbiBkZWNpZGVcbiAgICAvLyBsYXRlciBpZiB0aGV5IHdhbnQgbmV4dCB0byBiZSBhIG1ham9yIHRocm91Z2ggdGhlIGBDb25maWd1cmUgTmV4dCBhcyBNYWpvcmAgcmVsZWFzZSBhY3Rpb24uXG4gICAgY29uc3QgbmV3TmV4dFZlcnNpb24gPSBzZW12ZXIucGFyc2UoYCR7dmVyc2lvbi5tYWpvcn0uJHt2ZXJzaW9uLm1pbm9yICsgMX0uMC1uZXh0LjBgKSE7XG4gICAgY29uc3QgYnVtcENvbW1pdE1lc3NhZ2UgPSBnZXRDb21taXRNZXNzYWdlRm9yRXhjZXB0aW9uYWxOZXh0VmVyc2lvbkJ1bXAobmV3TmV4dFZlcnNpb24pO1xuXG4gICAgYXdhaXQgdGhpcy5jaGVja291dFVwc3RyZWFtQnJhbmNoKG5leHRCcmFuY2gpO1xuICAgIGF3YWl0IHRoaXMudXBkYXRlUHJvamVjdFZlcnNpb24obmV3TmV4dFZlcnNpb24pO1xuXG4gICAgLy8gQ3JlYXRlIGFuIGluZGl2aWR1YWwgY29tbWl0IGZvciB0aGUgbmV4dCB2ZXJzaW9uIGJ1bXAuIFRoZSBjaGFuZ2Vsb2cgc2hvdWxkIGdvIGludG9cbiAgICAvLyBhIHNlcGFyYXRlIGNvbW1pdCB0aGF0IG1ha2VzIGl0IGNsZWFyIHdoZXJlIHRoZSBjaGFuZ2Vsb2cgaXMgY2hlcnJ5LXBpY2tlZCBmcm9tLlxuICAgIGF3YWl0IHRoaXMuY3JlYXRlQ29tbWl0KGJ1bXBDb21taXRNZXNzYWdlLCBbcGFja2FnZUpzb25QYXRoXSk7XG5cbiAgICBhd2FpdCB0aGlzLnByZXBlbmRSZWxlYXNlTm90ZXNUb0NoYW5nZWxvZyhyZWxlYXNlTm90ZXMpO1xuXG4gICAgY29uc3QgY29tbWl0TWVzc2FnZSA9IGdldFJlbGVhc2VOb3RlQ2hlcnJ5UGlja0NvbW1pdE1lc3NhZ2UocmVsZWFzZU5vdGVzLnZlcnNpb24pO1xuXG4gICAgYXdhaXQgdGhpcy5jcmVhdGVDb21taXQoY29tbWl0TWVzc2FnZSwgW2NoYW5nZWxvZ1BhdGhdKTtcblxuICAgIGxldCBuZXh0UHVsbFJlcXVlc3RNZXNzYWdlID1cbiAgICAgIGBUaGUgcHJldmlvdXMgXCJuZXh0XCIgcmVsZWFzZS10cmFpbiBoYXMgbW92ZWQgaW50byB0aGUgYCArXG4gICAgICBgJHt0aGlzLm5ld1BoYXNlTmFtZX0gcGhhc2UuIFRoaXMgUFIgdXBkYXRlcyB0aGUgbmV4dCBicmFuY2ggdG8gdGhlIHN1YnNlcXVlbnQgYCArXG4gICAgICBgcmVsZWFzZS10cmFpbi5cXG5cXG5BbHNvIHRoaXMgUFIgY2hlcnJ5LXBpY2tzIHRoZSBjaGFuZ2Vsb2cgZm9yIGAgK1xuICAgICAgYHYke25ld1ZlcnNpb259IGludG8gdGhlICR7bmV4dEJyYW5jaH0gYnJhbmNoIHNvIHRoYXQgdGhlIGNoYW5nZWxvZyBpcyB1cCB0byBkYXRlLmA7XG5cbiAgICBjb25zdCBuZXh0VXBkYXRlUHVsbFJlcXVlc3QgPSBhd2FpdCB0aGlzLnB1c2hDaGFuZ2VzVG9Gb3JrQW5kQ3JlYXRlUHVsbFJlcXVlc3QoXG4gICAgICBuZXh0QnJhbmNoLFxuICAgICAgYG5leHQtcmVsZWFzZS10cmFpbi0ke25ld05leHRWZXJzaW9ufWAsXG4gICAgICBgVXBkYXRlIG5leHQgYnJhbmNoIHRvIHJlZmxlY3QgbmV3IHJlbGVhc2UtdHJhaW4gXCJ2JHtuZXdOZXh0VmVyc2lvbn1cIi5gLFxuICAgICAgbmV4dFB1bGxSZXF1ZXN0TWVzc2FnZSxcbiAgICApO1xuXG4gICAgaW5mbyhncmVlbihgICDinJMgICBQdWxsIHJlcXVlc3QgZm9yIHVwZGF0aW5nIHRoZSBcIiR7bmV4dEJyYW5jaH1cIiBicmFuY2ggaGFzIGJlZW4gY3JlYXRlZC5gKSk7XG4gICAgaW5mbyh5ZWxsb3coYCAgICAgIFBsZWFzZSBhc2sgdGVhbSBtZW1iZXJzIHRvIHJldmlldzogJHtuZXh0VXBkYXRlUHVsbFJlcXVlc3QudXJsfS5gKSk7XG4gIH1cbn1cbiJdfQ==
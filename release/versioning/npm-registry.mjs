/**
 * @license
 * Copyright Google LLC All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
import { __awaiter } from "tslib";
import fetch from 'node-fetch';
/**
 * Cache for requested NPM package information. A cache is desirable as the NPM
 * registry requests are usually very large and slow.
 */
export const _npmPackageInfoCache = {};
/**
 * Fetches the NPM package representing the project. Angular repositories usually contain
 * multiple packages in a monorepo scheme, but packages dealt with as part of the release
 * tooling are released together with the same versioning and branching. This means that
 * a single package can be used as source of truth for NPM package queries.
 */
export function fetchProjectNpmPackageInfo(config) {
    return __awaiter(this, void 0, void 0, function* () {
        const pkgName = getRepresentativeNpmPackage(config);
        return yield fetchPackageInfoFromNpmRegistry(pkgName);
    });
}
/** Gets whether the given version is published to NPM or not */
export function isVersionPublishedToNpm(version, config) {
    return __awaiter(this, void 0, void 0, function* () {
        const { versions } = yield fetchProjectNpmPackageInfo(config);
        return versions[version.format()] !== undefined;
    });
}
/**
 * Gets the representative NPM package for the specified release configuration. Angular
 * repositories usually contain multiple packages in a monorepo scheme, but packages dealt with
 * as part of the release tooling are released together with the same versioning and branching.
 * This means that a single package can be used as source of truth for NPM package queries.
 */
function getRepresentativeNpmPackage(config) {
    return config.npmPackages[0];
}
/** Fetches the specified NPM package from the NPM registry. */
function fetchPackageInfoFromNpmRegistry(pkgName) {
    return __awaiter(this, void 0, void 0, function* () {
        if (_npmPackageInfoCache[pkgName] === undefined) {
            _npmPackageInfoCache[pkgName] =
                fetch(`https://registry.npmjs.org/${pkgName}`).then(r => r.json());
        }
        return yield _npmPackageInfoCache[pkgName];
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibnBtLXJlZ2lzdHJ5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vZGV2LWluZnJhL3JlbGVhc2UvdmVyc2lvbmluZy9ucG0tcmVnaXN0cnkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HOztBQUVILE9BQU8sS0FBSyxNQUFNLFlBQVksQ0FBQztBQWUvQjs7O0dBR0c7QUFDSCxNQUFNLENBQUMsTUFBTSxvQkFBb0IsR0FBaUQsRUFBRSxDQUFDO0FBRXJGOzs7OztHQUtHO0FBQ0gsTUFBTSxVQUFnQiwwQkFBMEIsQ0FBQyxNQUFxQjs7UUFDcEUsTUFBTSxPQUFPLEdBQUcsMkJBQTJCLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDcEQsT0FBTyxNQUFNLCtCQUErQixDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3hELENBQUM7Q0FBQTtBQUVELGdFQUFnRTtBQUNoRSxNQUFNLFVBQWdCLHVCQUF1QixDQUN6QyxPQUFzQixFQUFFLE1BQXFCOztRQUMvQyxNQUFNLEVBQUMsUUFBUSxFQUFDLEdBQUcsTUFBTSwwQkFBMEIsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM1RCxPQUFPLFFBQVEsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUMsS0FBSyxTQUFTLENBQUM7SUFDbEQsQ0FBQztDQUFBO0FBRUQ7Ozs7O0dBS0c7QUFDSCxTQUFTLDJCQUEyQixDQUFDLE1BQXFCO0lBQ3hELE9BQU8sTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUMvQixDQUFDO0FBRUQsK0RBQStEO0FBQy9ELFNBQWUsK0JBQStCLENBQUMsT0FBZTs7UUFDNUQsSUFBSSxvQkFBb0IsQ0FBQyxPQUFPLENBQUMsS0FBSyxTQUFTLEVBQUU7WUFDL0Msb0JBQW9CLENBQUMsT0FBTyxDQUFDO2dCQUN6QixLQUFLLENBQUMsOEJBQThCLE9BQU8sRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7U0FDeEU7UUFDRCxPQUFPLE1BQU0sb0JBQW9CLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDN0MsQ0FBQztDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBMTEMgQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5cbmltcG9ydCBmZXRjaCBmcm9tICdub2RlLWZldGNoJztcbmltcG9ydCAqIGFzIHNlbXZlciBmcm9tICdzZW12ZXInO1xuXG5pbXBvcnQge1JlbGVhc2VDb25maWd9IGZyb20gJy4uL2NvbmZpZy9pbmRleCc7XG5cbi8qKiBUeXBlIGRlc2NyaWJpbmcgYW4gTlBNIHBhY2thZ2UgZmV0Y2hlZCBmcm9tIHRoZSByZWdpc3RyeS4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgTnBtUGFja2FnZUluZm8ge1xuICAvKiogTWFwcyBvZiB2ZXJzaW9ucyBhbmQgdGhlaXIgcGFja2FnZSBKU09OIG9iamVjdHMuICovXG4gICd2ZXJzaW9ucyc6IHtbbmFtZTogc3RyaW5nXTogdW5kZWZpbmVkfG9iamVjdH07XG4gIC8qKiBNYXAgb2YgTlBNIGRpc3QtdGFncyBhbmQgdGhlaXIgY2hvc2VuIHZlcnNpb24uICovXG4gICdkaXN0LXRhZ3MnOiB7W3RhZ05hbWU6IHN0cmluZ106IHN0cmluZ3x1bmRlZmluZWR9O1xuICAvKiogTWFwIG9mIHZlcnNpb25zIGFuZCB0aGVpciBJU08gcmVsZWFzZSB0aW1lLiAqL1xuICAndGltZSc6IHtbbmFtZTogc3RyaW5nXTogc3RyaW5nfTtcbn1cblxuLyoqXG4gKiBDYWNoZSBmb3IgcmVxdWVzdGVkIE5QTSBwYWNrYWdlIGluZm9ybWF0aW9uLiBBIGNhY2hlIGlzIGRlc2lyYWJsZSBhcyB0aGUgTlBNXG4gKiByZWdpc3RyeSByZXF1ZXN0cyBhcmUgdXN1YWxseSB2ZXJ5IGxhcmdlIGFuZCBzbG93LlxuICovXG5leHBvcnQgY29uc3QgX25wbVBhY2thZ2VJbmZvQ2FjaGU6IHtbcGtnTmFtZTogc3RyaW5nXTogUHJvbWlzZTxOcG1QYWNrYWdlSW5mbz59ID0ge307XG5cbi8qKlxuICogRmV0Y2hlcyB0aGUgTlBNIHBhY2thZ2UgcmVwcmVzZW50aW5nIHRoZSBwcm9qZWN0LiBBbmd1bGFyIHJlcG9zaXRvcmllcyB1c3VhbGx5IGNvbnRhaW5cbiAqIG11bHRpcGxlIHBhY2thZ2VzIGluIGEgbW9ub3JlcG8gc2NoZW1lLCBidXQgcGFja2FnZXMgZGVhbHQgd2l0aCBhcyBwYXJ0IG9mIHRoZSByZWxlYXNlXG4gKiB0b29saW5nIGFyZSByZWxlYXNlZCB0b2dldGhlciB3aXRoIHRoZSBzYW1lIHZlcnNpb25pbmcgYW5kIGJyYW5jaGluZy4gVGhpcyBtZWFucyB0aGF0XG4gKiBhIHNpbmdsZSBwYWNrYWdlIGNhbiBiZSB1c2VkIGFzIHNvdXJjZSBvZiB0cnV0aCBmb3IgTlBNIHBhY2thZ2UgcXVlcmllcy5cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGZldGNoUHJvamVjdE5wbVBhY2thZ2VJbmZvKGNvbmZpZzogUmVsZWFzZUNvbmZpZyk6IFByb21pc2U8TnBtUGFja2FnZUluZm8+IHtcbiAgY29uc3QgcGtnTmFtZSA9IGdldFJlcHJlc2VudGF0aXZlTnBtUGFja2FnZShjb25maWcpO1xuICByZXR1cm4gYXdhaXQgZmV0Y2hQYWNrYWdlSW5mb0Zyb21OcG1SZWdpc3RyeShwa2dOYW1lKTtcbn1cblxuLyoqIEdldHMgd2hldGhlciB0aGUgZ2l2ZW4gdmVyc2lvbiBpcyBwdWJsaXNoZWQgdG8gTlBNIG9yIG5vdCAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGlzVmVyc2lvblB1Ymxpc2hlZFRvTnBtKFxuICAgIHZlcnNpb246IHNlbXZlci5TZW1WZXIsIGNvbmZpZzogUmVsZWFzZUNvbmZpZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICBjb25zdCB7dmVyc2lvbnN9ID0gYXdhaXQgZmV0Y2hQcm9qZWN0TnBtUGFja2FnZUluZm8oY29uZmlnKTtcbiAgcmV0dXJuIHZlcnNpb25zW3ZlcnNpb24uZm9ybWF0KCldICE9PSB1bmRlZmluZWQ7XG59XG5cbi8qKlxuICogR2V0cyB0aGUgcmVwcmVzZW50YXRpdmUgTlBNIHBhY2thZ2UgZm9yIHRoZSBzcGVjaWZpZWQgcmVsZWFzZSBjb25maWd1cmF0aW9uLiBBbmd1bGFyXG4gKiByZXBvc2l0b3JpZXMgdXN1YWxseSBjb250YWluIG11bHRpcGxlIHBhY2thZ2VzIGluIGEgbW9ub3JlcG8gc2NoZW1lLCBidXQgcGFja2FnZXMgZGVhbHQgd2l0aFxuICogYXMgcGFydCBvZiB0aGUgcmVsZWFzZSB0b29saW5nIGFyZSByZWxlYXNlZCB0b2dldGhlciB3aXRoIHRoZSBzYW1lIHZlcnNpb25pbmcgYW5kIGJyYW5jaGluZy5cbiAqIFRoaXMgbWVhbnMgdGhhdCBhIHNpbmdsZSBwYWNrYWdlIGNhbiBiZSB1c2VkIGFzIHNvdXJjZSBvZiB0cnV0aCBmb3IgTlBNIHBhY2thZ2UgcXVlcmllcy5cbiAqL1xuZnVuY3Rpb24gZ2V0UmVwcmVzZW50YXRpdmVOcG1QYWNrYWdlKGNvbmZpZzogUmVsZWFzZUNvbmZpZykge1xuICByZXR1cm4gY29uZmlnLm5wbVBhY2thZ2VzWzBdO1xufVxuXG4vKiogRmV0Y2hlcyB0aGUgc3BlY2lmaWVkIE5QTSBwYWNrYWdlIGZyb20gdGhlIE5QTSByZWdpc3RyeS4gKi9cbmFzeW5jIGZ1bmN0aW9uIGZldGNoUGFja2FnZUluZm9Gcm9tTnBtUmVnaXN0cnkocGtnTmFtZTogc3RyaW5nKTogUHJvbWlzZTxOcG1QYWNrYWdlSW5mbz4ge1xuICBpZiAoX25wbVBhY2thZ2VJbmZvQ2FjaGVbcGtnTmFtZV0gPT09IHVuZGVmaW5lZCkge1xuICAgIF9ucG1QYWNrYWdlSW5mb0NhY2hlW3BrZ05hbWVdID1cbiAgICAgICAgZmV0Y2goYGh0dHBzOi8vcmVnaXN0cnkubnBtanMub3JnLyR7cGtnTmFtZX1gKS50aGVuKHIgPT4gci5qc29uKCkpO1xuICB9XG4gIHJldHVybiBhd2FpdCBfbnBtUGFja2FnZUluZm9DYWNoZVtwa2dOYW1lXTtcbn1cbiJdfQ==